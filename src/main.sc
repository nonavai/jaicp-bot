theme: /

    init:
        script:
            if (!$global.bookings) {
                $global.bookings = []
            }
            if (!$global.bookingCounter) {
                $global.bookingCounter = 1000
            }
            
            // –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            function normalizePhone(raw) {
                if (!raw) return raw
                
                var digits = raw.replace(/\D/g, '')
                
                if (digits.length === 10) return "+7" + digits
                if (digits.length === 11 && digits.charAt(0) === "8") return "+7" + digits.substring(1)
                if (digits.length === 11 && digits.charAt(0) === "7") return "+" + digits
                if (digits.length > 11) return "+" + digits
                
                return digits
            }
            
            // –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–º–µ–Ω–∏
            function normalizeName(raw) {
                if (!raw) return raw
                
                var parts = raw.trim().split(/\s+/)
                for (var i = 0; i < parts.length; i++) {
                    var p = parts[i].toLowerCase()
                    parts[i] = p.charAt(0).toUpperCase() + p.substring(1)
                }
                
                return parts.join(" ")
            }
            
            // –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∞—Ä–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
            function normalizeCarBrand(raw) {
                if (!raw) return raw
                
                var brandMap = {
                    "—à–∫–æ–¥–∞": "Skoda",
                    "–ª–∞–¥–∞": "Lada", 
                    "—Ç–æ–π–æ—Ç–∞": "Toyota",
                    "–∫–∏–∞": "KIA",
                    "—Ö–µ–Ω–¥–∞–π": "Hyundai",
                    "—Ñ–æ–ª—å–∫—Å–≤–∞–≥–µ–Ω": "Volkswagen",
                    "–±–º–≤": "BMW",
                    "–º–µ—Ä—Å–µ–¥–µ—Å": "Mercedes",
                    "–∞—É–¥–∏": "Audi",
                    "—Ñ–æ—Ä–¥": "Ford",
                    "—à–µ–≤—Ä–æ–ª–µ": "Chevrolet",
                    "–Ω–∏—Å—Å–∞–Ω": "Nissan",
                    "–º–∞–∑–¥–∞": "Mazda",
                    "—Ö–æ–Ω–¥–∞": "Honda",
                    "—Ä–µ–Ω–æ": "Renault",
                    "–ø–µ–∂–æ": "Peugeot",
                    "—Å–∏—Ç—Ä–æ–µ–Ω": "Citroen",
                    "–æ–ø–µ–ª—å": "Opel",
                    "–≤–æ–ª—å–≤–æ": "Volvo",
                    "–ª–µ–∫—Å—É—Å": "Lexus",
                    "–∏–Ω—Ñ–∏–Ω–∏—Ç–∏": "Infiniti",
                    "–∞–∫—É—Ä–∞": "Acura",
                    "—Å—É–±–∞—Ä—É": "Subaru",
                    "–º–∏—Ü—É–±–∏—Å–∏": "Mitsubishi",
                    "—Å—É–∑—É–∫–∏": "Suzuki"
                }
                
                var normalized = brandMap[raw.toLowerCase()]
                return normalized || raw.charAt(0).toUpperCase() + raw.substring(1).toLowerCase()
            }
            
            // –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏
            function validateBookingData(booking) {
                var errors = []
                
                if (!booking.name || booking.name.length < 2) {
                    errors.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è")
                }
                
                if (!booking.phone || booking.phone.length < 10) {
                    errors.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞")
                }
                
                if (!booking.brand || booking.brand.length < 2) {
                    errors.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –º–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è")
                }
                
                return {
                    isValid: errors.length === 0,
                    errors: errors
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
            function formatDate(isoString) {
                var date = new Date(isoString)
                return date.toLocaleDateString("ru-RU") + " " + date.toLocaleTimeString("ru-RU", {hour: '2-digit', minute:'2-digit'})
            }

    state: greeting
        q: * –ø—Ä–∏–≤–µ—Ç *
        q: * –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ *
        q: * –¥–æ–±—Ä—ã–π *
        q: * –Ω–∞—á–∞—Ç—å *
        q: * –ø–æ–º–æ—â—å *
        a: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å –ê–≤—Ç–æ–ü—Ä–æ—Ñ–∏! –Ø –ø–æ–º–æ–≥—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ.
        script:
            $session.bookingData = {}

    state: farewell  
        q: * –ø–æ–∫–∞ *
        q: * —Å–ø–∞—Å–∏–±–æ *
        q: * —Å–≤–∏–¥–∞–Ω–∏—è *
        a: –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!

    state: working_hours
        q: * —á–∞—Å—ã *
        q: * –≤—Ä–µ–º—è *
        q: * —Ä–∞–±–æ—Ç–∞–µ—Ç–µ *
        q: * —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ *
        a: –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–∞ –ê–≤—Ç–æ–ü—Ä–æ—Ñ–∏: –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–ü—è—Ç–Ω–∏—Ü–∞ 8:00-20:00, –°—É–±–±–æ—Ç–∞ 9:00-18:00. –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ - –≤—ã—Ö–æ–¥–Ω–æ–π.

    state: price_inquiry
        q: * —Ü–µ–Ω—ã *
        q: * —Å—Ç–æ–∏–º–æ—Å—Ç—å *
        q: * —Å–∫–æ–ª—å–∫–æ *
        q: * —Ç–∞—Ä–∏—Ñ *
        a: –¶–µ–Ω—ã –Ω–∞ —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ: –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –æ—Ç 2500 —Ä—É–±, –°—Ä–µ–¥–Ω–µ—Ä–∞–∑–º–µ—Ä–Ω—ã–µ –æ—Ç 3500 —Ä—É–±, –ü–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã–µ –æ—Ç 4500 —Ä—É–±.

    state: service_booking
        q: * –∑–∞–ø–∏—Å–∞—Ç—å—Å—è *
        q: * –∑–∞–ø–∏—Å—å *
        q: * –¢–û *
        q: * —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ *
        q: * –ø–æ–ø–∞—Å—Ç—å *
        q: * –∑–∞–ø–∏—Å–∞—Ç—å *
        q: * –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ *
        q: * —Ä–µ–º–æ–Ω—Ç *
        q: * —Å–µ—Ä–≤–∏—Å *
        q: * –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ *
        a: –•–æ—Ä–æ—à–æ! –î–∞–≤–∞–π—Ç–µ –æ—Ñ–æ—Ä–º–∏–º –∑–∞–ø–∏—Å—å –Ω–∞ —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ. –£–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –º–∞—Ä–∫—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è.
        script:
            $session.bookingData = {}
            $reactions.transition("ask_name")

    state: ask_name
        a: –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?
        script:
            // –°–æ–±–∏—Ä–∞–µ–º –∏–º—è –∏–∑ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            var text = $request.query
            if (text && text.length > 2) {
                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–º—è (–±—É–∫–≤—ã –∏ –ø—Ä–æ–±–µ–ª—ã)
                if (/^[–ê-–Ø–∞-—èA-Za-z\s]+$/.test(text)) {
                    $session.bookingData.name = normalizeName(text)
                    $reactions.transition("ask_phone")
                    return
                }
            }
            $reactions.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤)")

    state: ask_phone
        a: –£–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        script:
            var text = $request.query
            if (text && text.length > 6) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ü–∏—Ñ—Ä—ã –≤ —Ç–µ–∫—Å—Ç–µ
                if (/\d/.test(text)) {
                    $session.bookingData.phone = normalizePhone(text)
                    $reactions.transition("ask_car_brand")
                    return
                }
            }
            $reactions.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 8-999-123-45-67)")

    state: ask_car_brand
        a: –ö–∞–∫–∞—è –º–∞—Ä–∫–∞ –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è?
        script:
            var text = $request.query
            if (text && text.length > 1) {
                $session.bookingData.brand = normalizeCarBrand(text)
                $reactions.transition("confirm_booking")
                return
            }
            $reactions.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –º–∞—Ä–∫—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: Toyota)")

    state: confirm_booking
        a: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ:\nüìù –ò–º—è: {{ $session.bookingData.name }}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: {{ $session.bookingData.phone }}\nüöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å: {{ $session.bookingData.brand }}\n\n–í—Å–µ –≤–µ—Ä–Ω–æ? –ù–∞–ø–∏—à–∏—Ç–µ "–¥–∞" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ "–Ω–µ—Ç" –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è.

    state: process_confirmation
        q: * –¥–∞ *
        q: * –∫–æ–Ω–µ—á–Ω–æ *
        q: * –≤–µ—Ä–Ω–æ *
        q: * –ø—Ä–∞–≤–∏–ª—å–Ω–æ *
        q: * –∞–≥–∞ *
        script:
            var bookingId = "BK" + (++$global.bookingCounter)
            
            var booking = {
                id: bookingId,
                userId: $session.userId || "anonymous",
                name: $session.bookingData.name,
                phone: $session.bookingData.phone,
                brand: $session.bookingData.brand,
                status: "New",
                createdAt: new Date().toISOString(),
                confirmedAt: new Date().toISOString()
            }
            
            var validation = validateBookingData(booking)
            if (!validation.isValid) {
                $reactions.answer("–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö: " + validation.errors.join(", "))
                return
            }
            
            $global.bookings.push(booking)
            $session.lastBookingId = bookingId
            
            $reactions.answer("‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!\nüìã –ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏: " + bookingId + "\n‚è∞ –ù–∞—à —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏.")

    state: process_negation
        q: * –Ω–µ—Ç *
        q: * –Ω–µ *
        q: * –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ *
        q: * –æ—à–∏–±–∫–∞ *
        a: –•–æ—Ä–æ—à–æ, –¥–∞–≤–∞–π—Ç–µ —É—Ç–æ—á–Ω–∏–º –¥–∞–Ω–Ω—ã–µ. –ß—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å?
        script:
            $session.bookingData = {}
            $reactions.transition("service_booking")

    state: view_bookings
        q: * –∑–∞—è–≤–∫–∏ *
        q: * –∑–∞–ø–∏—Å–∏ *
        q: * —Å—Ç–∞—Ç—É—Å *
        q: * –ø–æ–∫–∞–∑–∞—Ç—å *
        script:
            var userId = $session.userId || "anonymous"
            var userBookings = []
            
            for (var i = 0; i < $global.bookings.length; i++) {
                if ($global.bookings[i].userId === userId) {
                    userBookings.push($global.bookings[i])
                }
            }
            
            if (userBookings.length === 0) {
                $reactions.answer("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫.")
            } else {
                var message = "üìã –í–∞—à–∏ –∑–∞—è–≤–∫–∏:\n\n"
                for (var j = 0; j < userBookings.length; j++) {
                    var booking = userBookings[j]
                    message += "üÜî " + booking.id + "\n"
                    message += "üöó " + booking.brand + "\n"
                    message += "üìä –°—Ç–∞—Ç—É—Å: " + booking.status + "\n"
                    message += "üìÖ –°–æ–∑–¥–∞–Ω–æ: " + formatDate(booking.createdAt) + "\n\n"
                }
                $reactions.answer(message)
            }

    state: default
        event: noMatch
        a: –ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –ø–æ–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è" - –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –¢–û\n‚Ä¢ "—Ü–µ–Ω—ã" - —É–∑–Ω–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å\n‚Ä¢ "—á–∞—Å—ã" - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã\n‚Ä¢ "–∑–∞—è–≤–∫–∏" - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø–∏—Å–∏